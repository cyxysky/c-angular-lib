<!-- åŸºç¡€è¾“å…¥æ¡† -->
<div class="date-timer-container" [class.date-timer-disabled]="disabled" cdkOverlayOrigin>
  <!-- å•ä¸ªæ—¥æœŸ/æ—¶é—´é€‰æ‹© -->
  <div *ngIf="selectType === 'single'" class="date-timer-single" (click)="openDropdown()">
    <div class="date-timer-input" 
         [class.date-timer-input-focused]="isFocused"
         [class.date-timer-input-disabled]="disabled"
         [class.date-timer-input-borderless]="borderless"
         [class.date-timer-input-error]="status === 'error'"
         [class.date-timer-input-warning]="status === 'warning'"
         [class.date-timer-input-small]="size === 'small'"
         [class.date-timer-input-large]="size === 'large'">
      <input 
        #inputElement
        type="text" 
        [placeholder]="placeholder.toString()"
        [disabled]="disabled"
        [value]="displayValue"
        readonly
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
      />
      <div class="date-timer-suffix">
        <span *ngIf="allowClear && displayValue" class="date-timer-clear-btn" (click)="clearValue($event)">Ã—</span>
        <span class="date-timer-icon">ğŸ“…</span>
      </div>
    </div>
  </div>

  <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
  <div *ngIf="selectType === 'range'" class="date-timer-range" (click)="openDropdown()">
    <div class="date-timer-input" 
         [class.date-timer-input-focused]="isFocused"
         [class.date-timer-input-disabled]="disabled"
         [class.date-timer-input-borderless]="borderless"
         [class.date-timer-input-error]="status === 'error'"
         [class.date-timer-input-warning]="status === 'warning'"
         [class.date-timer-input-small]="size === 'small'"
         [class.date-timer-input-large]="size === 'large'">
      <input 
        type="text" 
        [placeholder]="rangePlaceholder[0]"
        [disabled]="disabled"
        [value]="getStartDate() ? formatDate(getStartDate()!) : ''"
        readonly
      />
      <span class="date-timer-range-separator">~</span>
      <input 
        type="text" 
        [placeholder]="rangePlaceholder[1]"
        [disabled]="disabled"
        [value]="getEndDate() ? formatDate(getEndDate()!) : ''"
        readonly
      />
      <div class="date-timer-suffix">
        <span *ngIf="allowClear && displayValue" class="date-timer-clear-btn" (click)="clearValue($event)">Ã—</span>
        <span class="date-timer-icon">ğŸ“…</span>
      </div>
    </div>
  </div>
</div>

<!-- ä¸‹æ‹‰é¢æ¿æ¨¡æ¿ -->
<ng-template #dropdownTemplate>
  <div 
    class="date-timer-dropdown"
    [class.date-timer-dropdown-time]="currentPanelMode === 'time' && !showTime"
    [class.date-timer-dropdown-date-time]="showTime && ['date', 'week'].includes(mode)"
  >
    <!-- æ·»åŠ å¼€å§‹/ç»“æŸé€‰æ‹©æŒ‰é’®Tabï¼Œåªåœ¨èŒƒå›´é€‰æ‹©æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <div *ngIf="selectType === 'range'" class="date-timer-range-tabs">
      <button 
        class="date-timer-range-tab" 
        [class.date-timer-range-tab-active]="rangePart === 'start'"
        (click)="switchRangePart('start')"
      >
        å¼€å§‹
      </button>
      <button 
        class="date-timer-range-tab" 
        [class.date-timer-range-tab-active]="rangePart === 'end'"
        (click)="switchRangePart('end')"
      >
        ç»“æŸ
      </button>
    </div>
    
    <div class="date-timer-panels-container">
      <!-- å¹´ä»½é€‰æ‹©é¢æ¿ -->
      <div *ngIf="currentPanelMode === 'year'" class="date-timer-year-panel">
        <div class="date-timer-header">
          <button class="date-timer-prev-year-btn" (click)="prevYearRange()">&lt;&lt;</button>
          <span class="date-timer-header-view">{{ yearRangeText }}</span>
          <button class="date-timer-next-year-btn" (click)="nextYearRange()">&gt;&gt;</button>
        </div>
        <div class="date-timer-body">
          <div class="date-timer-year-grid">
            <div 
              *ngFor="let year of years" 
              class="date-timer-year-cell"
              [class.date-timer-cell-selected]="isSelectedYear(year)"
              [class.date-timer-cell-in-range]="isInYearRange(year)"
              (click)="onSelectYear(year)"
              (mouseenter)="selectType === 'range' && onCellYearHover(year)"
            >
              {{ year }}
            </div>
          </div>
        </div>
      </div>
      
      <!-- æœˆä»½é€‰æ‹©é¢æ¿ -->
      <div *ngIf="currentPanelMode === 'month'" class="date-timer-month-panel">
        <div class="date-timer-header">
          <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
          <span *ngIf="mode === 'date'" class="date-timer-header-view">
            <span class="date-timer-header-clickable" (click)="onHeaderClick('year')">{{ getYear(currentViewDate) }}å¹´</span>
          </span>
          <span *ngIf="mode !== 'date'" class="date-timer-header-view">{{ getYear(currentViewDate) }}</span>
          <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
        </div>
        <div class="date-timer-body">
          <div class="date-timer-month-grid">
            <div 
              *ngFor="let month of months; let i = index" 
              class="date-timer-month-cell"
              [class.date-timer-cell-selected]="isSelectedMonth(i)"
              [class.date-timer-cell-in-range]="isInMonthRange(i)"
              (click)="onSelectMonth(i)"
              (mouseenter)="selectType === 'range' && onCellMonthHover(i)"
            >
              {{ i + 1 }}æœˆ
            </div>
          </div>
        </div>
      </div>
      
      <!-- å­£åº¦é€‰æ‹©é¢æ¿ -->
      <div *ngIf="currentPanelMode === 'quarter'" class="date-timer-quarter-panel">
        <div class="date-timer-header">
          <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
          <span class="date-timer-header-view">{{ getYear(currentViewDate) }}</span>
          <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
        </div>
        <div class="date-timer-body">
          <div class="date-timer-quarter-grid">
            <div 
              *ngFor="let quarter of quarters; let i = index" 
              class="date-timer-quarter-cell"
              [class.date-timer-cell-selected]="isSelectedQuarter(i)"
              [class.date-timer-cell-in-range]="isInQuarterRange(i)"
              (click)="onSelectQuarter(i)"
              (mouseenter)="selectType === 'range' && onCellQuarterHover(i)"
            >
              {{ i + 1 }}å­£åº¦
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ—¥æœŸé¢æ¿ï¼ˆç”¨äºæ—¥æœŸå’Œå‘¨é€‰æ‹©ï¼‰ -->
      <div *ngIf="currentPanelMode === 'date' || (showTime && ['date', 'week'].includes(mode))" class="date-timer-date-panel"
           [class.date-timer-date-panel-week-mode]="mode === 'week'">
        <!-- é¢æ¿å¤´éƒ¨ -->
        <div class="date-timer-header">
          <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
          <button class="date-timer-prev-month-btn" (click)="prevMonth()">&lt;</button>
          
          <!-- æ—¥æœŸæ¨¡å¼ä¸‹çš„å¯ç‚¹å‡»æ ‡é¢˜ -->
          <span *ngIf="mode === 'date'" class="date-timer-header-view">
            <span class="date-timer-header-clickable" (click)="onHeaderClick('year')">{{ getHeaderYear() }}</span>
            <span class="date-timer-header-clickable" (click)="onHeaderClick('month')">{{ getHeaderMonth() }}</span>
          </span>
          
          <!-- å…¶ä»–æ¨¡å¼ä¸‹çš„åªè¯»æ ‡é¢˜ -->
          <span *ngIf="mode !== 'date'" class="date-timer-header-view">{{ getHeaderText() }}</span>
          
          <button class="date-timer-next-month-btn" (click)="nextMonth()">&gt;</button>
          <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
        </div>

        <!-- æ˜ŸæœŸæ ‡é¢˜ -->
        <div class="date-timer-weekdays">
          <!-- å‘¨æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºå‘¨æ•°æ ‡é¢˜åˆ— -->
          <div *ngIf="mode === 'week'" class="date-timer-weekday-week-num">å‘¨</div>
          <div *ngFor="let weekday of weekdays" class="date-timer-weekday">{{ weekday }}</div>
        </div>

        <!-- æ—¥æœŸè¡¨ -->
        <div class="date-timer-body">
          <!-- æ—¥æœŸé€‰æ‹© -->
          <ng-container *ngIf="mode !== 'week'">
            <div class="date-timer-week" *ngFor="let week of dateMatrix">
              <div 
                *ngFor="let day of week" 
                class="date-timer-cell"
                [class.date-timer-cell-disabled]="isDateDisabled(day)"
                [class.date-timer-cell-selected]="isSelectedDay(day)"
                [class.date-timer-cell-in-range]="isInRange(day)"
                [class.date-timer-cell-prev-month]="getMonth(day) !== getMonth(currentViewDate)"
                [class.date-timer-cell-next-month]="getMonth(day) !== getMonth(currentViewDate)"
                [class.date-timer-cell-today]="isToday(day)"
                (click)="onSelectDate(day)"
                (mouseenter)="onCellHover(day)"
              >
                <div class="date-timer-cell-content">
                  <ng-container *ngIf="dateRender; else defaultCellContent">
                    {{ renderDateCell(day) }}
                  </ng-container>
                  <ng-template #defaultCellContent>
                    {{ getDate(day) }}
                  </ng-template>
                </div>
              </div>
            </div>
          </ng-container>
          
          <!-- å‘¨é€‰æ‹© -->
          <ng-container *ngIf="mode === 'week'">
            <div class="date-timer-week" 
                 *ngFor="let week of dateMatrix; let i = index"
                 [class.date-timer-week-selected]="isWeekInDateRange(week)"
                 [class.date-timer-week-in-range]="isInWeekRange(week)">
              <!-- å‘¨æ•°æŒ‡ç¤ºå™¨ -->
              <div class="date-timer-week-indicator" (click)="onSelectWeek(week)">
                {{ getWeekNumber(week[0]) }}
              </div>
              <div 
                *ngFor="let day of week" 
                class="date-timer-cell"
                [class.date-timer-cell-in-week]="isWeekInDateRange(week)"
                [class.date-timer-cell-selected]="isSelectedDay(day)"
                [class.date-timer-cell-in-range]="isInWeekRange(week)"
                [class.date-timer-cell-disabled]="isDateDisabled(day)"
                [class.date-timer-cell-prev-month]="getMonth(day) !== getMonth(currentViewDate)"
                [class.date-timer-cell-next-month]="getMonth(day) !== getMonth(currentViewDate)"
                [class.date-timer-cell-today]="isToday(day)"
                (click)="onSelectWeek(week)"
                (mouseenter)="selectType === 'range' && onCellWeekHover(week)"
              >
                <div class="date-timer-cell-content">{{ getDate(day) }}</div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- æ—¶é—´é€‰æ‹©é¢æ¿ - ç‹¬ç«‹æ¨¡å¼ -->
      <div *ngIf="mode === 'time' && currentPanelMode === 'time' && !showTime" class="date-timer-time-panel">
        
        <!-- æ—¶é—´é€‰æ‹©æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="date-timer-time-steps" *ngIf="selectType === 'range'">
          <span class="date-timer-time-step" [class.date-timer-time-step-active]="timeSelectStep === 'hour'">æ—¶</span> â†’ 
          <span class="date-timer-time-step" [class.date-timer-time-step-active]="timeSelectStep === 'minute'">åˆ†</span> â†’ 
          <span class="date-timer-time-step" [class.date-timer-time-step-active]="timeSelectStep === 'second'">ç§’</span>
        </div>
        
        <div class="date-timer-time-columns">
          <!-- å°æ—¶ -->
          <div class="date-timer-time-column" [class.date-timer-time-column-active]="timeSelectStep === 'hour'">
            <div class="date-timer-time-column-title">æ—¶</div>
            <ul>
              <li *ngFor="let hour of hours" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('hour', hour)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('hour', hour)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('hour', hour)"
                  (click)="onSelectHour(hour)"
                  (mouseenter)="onTimeHover('hour', hour)">
                {{ hour < 10 ? '0' + hour : hour }}
              </li>
            </ul>
          </div>
          <!-- åˆ†é’Ÿ -->
          <div class="date-timer-time-column" [class.date-timer-time-column-active]="timeSelectStep === 'minute'">
            <div class="date-timer-time-column-title">åˆ†</div>
            <ul>
              <li *ngFor="let minute of minutes" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('minute', minute)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('minute', minute)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('minute', minute)"
                  (click)="onSelectMinute(minute)"
                  (mouseenter)="onTimeHover('minute', minute)">
                {{ minute < 10 ? '0' + minute : minute }}
              </li>
            </ul>
          </div>
          <!-- ç§’é’Ÿ -->
          <div class="date-timer-time-column" [class.date-timer-time-column-active]="timeSelectStep === 'second'">
            <div class="date-timer-time-column-title">ç§’</div>
            <ul>
              <li *ngFor="let second of seconds" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('second', second)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('second', second)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('second', second)"
                  (click)="onSelectSecond(second)"
                  (mouseenter)="onTimeHover('second', second)">
                {{ second < 10 ? '0' + second : second }}
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- æ—¶é—´é€‰æ‹©é¢æ¿ - ç»„åˆæ¨¡å¼ -->
      <div *ngIf="showTime && ['date', 'week'].includes(mode)" class="date-timer-time-panel date-timer-time-panel-combined">
        <div class="date-timer-time-columns">
          <!-- å°æ—¶ -->
          <div class="date-timer-time-column">
            <div class="date-timer-time-column-title">æ—¶</div>
            <ul>
              <li *ngFor="let hour of hours" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('hour', hour)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('hour', hour)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('hour', hour)"
                  (click)="onSelectHour(hour)"
                  (mouseenter)="onTimeHover('hour', hour)">
                {{ hour < 10 ? '0' + hour : hour }}
              </li>
            </ul>
          </div>
          <!-- åˆ†é’Ÿ -->
          <div class="date-timer-time-column">
            <div class="date-timer-time-column-title">åˆ†</div>
            <ul>
              <li *ngFor="let minute of minutes" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('minute', minute)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('minute', minute)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('minute', minute)"
                  (click)="onSelectMinute(minute)"
                  (mouseenter)="onTimeHover('minute', minute)">
                {{ minute < 10 ? '0' + minute : minute }}
              </li>
            </ul>
          </div>
          <!-- ç§’é’Ÿ -->
          <div class="date-timer-time-column">
            <div class="date-timer-time-column-title">ç§’</div>
            <ul>
              <li *ngFor="let second of seconds" 
                  class="date-timer-time-cell"
                  [class.date-timer-time-cell-selected]="isSelectedTimeUnit('second', second)"
                  [class.date-timer-time-cell-in-range]="selectType === 'range' && isInTimeRange('second', second)"
                  [class.date-timer-time-cell-disabled]="isTimeDisabled('second', second)"
                  (click)="onSelectSecond(second)"
                  (mouseenter)="onTimeHover('second', second)">
                {{ second < 10 ? '0' + second : second }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- é¢å¤–é¡µè„š -->
    <div *ngIf="extraFooter" class="date-timer-footer-extra">
      <ng-container *ngIf="typeof extraFooter === 'string'">{{ extraFooter }}</ng-container>
      <ng-container *ngIf="typeof extraFooter !== 'string'">
        <!-- <ng-container *ngTemplateOutlet="extraFooter"></ng-container> -->
      </ng-container>
    </div>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="date-timer-footer" *ngIf="showTime || mode === 'time' || showToday">
      <div *ngIf="showTime || mode === 'time'" class="date-timer-time-display">
        <ng-container *ngIf="selectType === 'single' && isSingleDate(selectedValue)">
          {{ selectedValue.getHours() | number:'2.0-0' }}:{{ selectedValue.getMinutes() | number:'2.0-0' }}:{{ selectedValue.getSeconds() | number:'2.0-0' }}
        </ng-container>
        <ng-container *ngIf="selectType === 'single' && isRangeValue(selectedValue) && selectedValue.start">
          {{ selectedValue.start.getHours() | number:'2.0-0' }}:{{ selectedValue.start.getMinutes() | number:'2.0-0' }}:{{ selectedValue.start.getSeconds() | number:'2.0-0' }}
        </ng-container>
        <ng-container *ngIf="selectType === 'range' && isRangeValue(selectedValue)">
          <ng-container *ngIf="rangePart === 'start' && selectedValue.start">
            å¼€å§‹: {{ selectedValue.start.getHours() | number:'2.0-0' }}:{{ selectedValue.start.getMinutes() | number:'2.0-0' }}:{{ selectedValue.start.getSeconds() | number:'2.0-0' }}
          </ng-container>
          <ng-container *ngIf="rangePart === 'end'">
            <ng-container *ngIf="selectedValue.start && !selectedValue.end">
              ç»“æŸ: è¯·é€‰æ‹©ç»“æŸæ—¶é—´
            </ng-container>
            <ng-container *ngIf="selectedValue.start && selectedValue.end">
              ç»“æŸ: {{ selectedValue.end.getHours() | number:'2.0-0' }}:{{ selectedValue.end.getMinutes() | number:'2.0-0' }}:{{ selectedValue.end.getSeconds() | number:'2.0-0' }}
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
      <div class="date-timer-footer-buttons">
        <button *ngIf="showToday && currentPanelMode !== 'time'" class="date-timer-now-btn" (click)="today()">ä»Šå¤©</button>
        <button *ngIf="showTime || mode === 'time'" class="date-timer-now-btn" (click)="setCurrentTime()">æ­¤åˆ»</button>
        <button class="date-timer-ok-btn" (click)="confirm()">ç¡®å®š</button>
      </div>
    </div>
  </div>
</ng-template> 