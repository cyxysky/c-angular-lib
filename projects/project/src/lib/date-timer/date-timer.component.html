<!-- åŸºç¡€è¾“å…¥æ¡† -->
<div class="date-timer-container" [class.date-timer-disabled]="disabled" cdkOverlayOrigin>
  <!-- å•ä¸ªæ—¥æœŸ/æ—¶é—´é€‰æ‹© -->
  <div *ngIf="selectType === 'single'" class="date-timer-single" (click)="openDropdown()">
    <div class="date-timer-input" 
         [class.date-timer-input-focused]="isFocused"
         [class.date-timer-input-disabled]="disabled"
         [class.date-timer-input-borderless]="borderless"
         [class.date-timer-input-error]="status === 'error'"
         [class.date-timer-input-warning]="status === 'warning'"
         [class.date-timer-input-small]="size === 'small'"
         [class.date-timer-input-large]="size === 'large'">
      <input 
        #inputElement
        type="text" 
        [placeholder]="placeholder.toString()"
        [disabled]="disabled"
        [value]="displayValue"
        readonly
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
      />
      <div class="date-timer-suffix">
        <span *ngIf="allowClear && displayValue" class="date-timer-clear-btn" (click)="clearValue($event)">Ã—</span>
        <span class="date-timer-icon">ðŸ“…</span>
      </div>
    </div>
  </div>

  <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
  <div *ngIf="selectType === 'range'" class="date-timer-range" (click)="openDropdown()">
    <div class="date-timer-input" 
         [class.date-timer-input-focused]="isFocused"
         [class.date-timer-input-disabled]="disabled"
         [class.date-timer-input-borderless]="borderless"
         [class.date-timer-input-error]="status === 'error'"
         [class.date-timer-input-warning]="status === 'warning'"
         [class.date-timer-input-small]="size === 'small'"
         [class.date-timer-input-large]="size === 'large'">
      <input 
        type="text" 
        [placeholder]="rangePlaceholder[0]"
        [disabled]="disabled"
        [value]="getStartDate() ? formatDate(getStartDate()!) : ''"
        readonly
      />
      <span class="date-timer-range-separator">~</span>
      <input 
        type="text" 
        [placeholder]="rangePlaceholder[1]"
        [disabled]="disabled"
        [value]="getEndDate() ? formatDate(getEndDate()!) : ''"
        readonly
      />
      <div class="date-timer-suffix">
        <span *ngIf="allowClear && displayValue" class="date-timer-clear-btn" (click)="clearValue($event)">Ã—</span>
        <span class="date-timer-icon">ðŸ“…</span>
      </div>
    </div>
  </div>
</div>

<!-- ä¸‹æ‹‰é¢æ¿æ¨¡æ¿ -->
<ng-template #dropdownTemplate>
  <div 
    class="date-timer-dropdown"
    [class.date-timer-dropdown-time]="currentPanelMode === 'time'"
    [class.date-timer-dropdown-date-time]="showTime && ['date', 'week'].includes(mode)"
  >
    <!-- å¹´ä»½é€‰æ‹©é¢æ¿ -->
    <div *ngIf="currentPanelMode === 'year'" class="date-timer-year-panel">
      <div class="date-timer-header">
        <button class="date-timer-prev-year-btn" (click)="prevYearRange()">&lt;&lt;</button>
        <span class="date-timer-header-view">{{ yearRangeText }}</span>
        <button class="date-timer-next-year-btn" (click)="nextYearRange()">&gt;&gt;</button>
      </div>
      <div class="date-timer-body">
        <div class="date-timer-year-grid">
          <div 
            *ngFor="let year of years" 
            class="date-timer-year-cell"
            [class.date-timer-cell-selected]="isSelectedYear(year)"
            (click)="onSelectYear(year)"
          >
            {{ year }}
          </div>
        </div>
      </div>
    </div>
    
    <!-- æœˆä»½é€‰æ‹©é¢æ¿ -->
    <div *ngIf="currentPanelMode === 'month'" class="date-timer-month-panel">
      <div class="date-timer-header">
        <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
        <span *ngIf="mode === 'date'" class="date-timer-header-view date-timer-header-clickable" (click)="onHeaderClick('month-header')">{{ getYear(currentViewDate) }}</span>
        <span *ngIf="mode !== 'date'" class="date-timer-header-view">{{ getYear(currentViewDate) }}</span>
        <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
      </div>
      <div class="date-timer-body">
        <div class="date-timer-month-grid">
          <div 
            *ngFor="let month of months; let i = index" 
            class="date-timer-month-cell"
            [class.date-timer-cell-selected]="isSelectedMonth(i)"
            (click)="onSelectMonth(i)"
          >
            {{ i + 1 }}æœˆ
          </div>
        </div>
      </div>
    </div>
    
    <!-- å­£åº¦é€‰æ‹©é¢æ¿ -->
    <div *ngIf="currentPanelMode === 'quarter'" class="date-timer-quarter-panel">
      <div class="date-timer-header">
        <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
        <span class="date-timer-header-view">{{ getYear(currentViewDate) }}</span>
        <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
      </div>
      <div class="date-timer-body">
        <div class="date-timer-quarter-grid">
          <div 
            *ngFor="let quarter of quarters; let i = index" 
            class="date-timer-quarter-cell"
            [class.date-timer-cell-selected]="isSelectedQuarter(i)"
            (click)="onSelectQuarter(i)"
          >
            {{ i + 1 }}å­£åº¦
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ—¥æœŸé€‰æ‹©é¢æ¿ï¼ˆç”¨äºŽæ—¥æœŸå’Œå‘¨é€‰æ‹©ï¼‰ -->
    <div *ngIf="currentPanelMode === 'date'" class="date-timer-date-panel">
      <!-- é¢æ¿å¤´éƒ¨ -->
      <div class="date-timer-header">
        <button class="date-timer-prev-year-btn" (click)="prevYear()">&lt;&lt;</button>
        <button class="date-timer-prev-month-btn" (click)="prevMonth()">&lt;</button>
        <span *ngIf="mode === 'date'" class="date-timer-header-view date-timer-header-clickable" (click)="onHeaderClick('date-header')">{{ getHeaderText() }}</span>
        <span *ngIf="mode !== 'date'" class="date-timer-header-view">{{ getHeaderText() }}</span>
        <button class="date-timer-next-month-btn" (click)="nextMonth()">&gt;</button>
        <button class="date-timer-next-year-btn" (click)="nextYear()">&gt;&gt;</button>
      </div>

      <!-- æ˜ŸæœŸæ ‡é¢˜ -->
      <div class="date-timer-weekdays">
        <div *ngFor="let weekday of weekdays" class="date-timer-weekday">{{ weekday }}</div>
      </div>

      <!-- æ—¥æœŸè¡¨ -->
      <div class="date-timer-body">
        <!-- æ—¥æœŸé€‰æ‹© -->
        <ng-container *ngIf="mode !== 'week'">
          <div class="date-timer-week" *ngFor="let week of dateMatrix">
            <div 
              *ngFor="let day of week" 
              class="date-timer-cell"
              [class.date-timer-cell-disabled]="isDateDisabled(day)"
              [class.date-timer-cell-selected]="isSelectedDay(day)"
              [class.date-timer-cell-in-range]="isInRange(day)"
              [class.date-timer-cell-prev-month]="getMonth(day) !== getMonth(currentViewDate)"
              [class.date-timer-cell-next-month]="getMonth(day) !== getMonth(currentViewDate)"
              [class.date-timer-cell-today]="isToday(day)"
              (click)="onSelectDate(day)"
              (mouseenter)="onCellHover(day)"
            >
              <div class="date-timer-cell-content">
                <ng-container *ngIf="dateRender; else defaultCellContent">
                  {{ renderDateCell(day) }}
                </ng-container>
                <ng-template #defaultCellContent>
                  {{ getDate(day) }}
                </ng-template>
              </div>
            </div>
          </div>
        </ng-container>
        
        <!-- å‘¨é€‰æ‹© -->
        <ng-container *ngIf="mode === 'week'">
          <div class="date-timer-week" 
               *ngFor="let week of dateMatrix; let i = index"
               [class.date-timer-week-selected]="isWeekInDateRange(week)">
            <div 
              *ngFor="let day of week" 
              class="date-timer-cell"
              [class.date-timer-cell-in-week]="isWeekInDateRange(week)"
              [class.date-timer-cell-selected]="isSelectedDay(day)"
              [class.date-timer-cell-disabled]="isDateDisabled(day)"
              [class.date-timer-cell-prev-month]="getMonth(day) !== getMonth(currentViewDate)"
              [class.date-timer-cell-next-month]="getMonth(day) !== getMonth(currentViewDate)"
              [class.date-timer-cell-today]="isToday(day)"
              (click)="onSelectWeek(week)"
            >
              <div class="date-timer-cell-content">{{ getDate(day) }}</div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- æ—¶é—´é€‰æ‹©é¢æ¿ -->
    <div *ngIf="showTime && currentPanelMode === 'time'" class="date-timer-time-panel">
      <div class="date-timer-time-columns">
        <!-- å°æ—¶ -->
        <div class="date-timer-time-column">
          <ul>
            <li *ngFor="let hour of hours" 
                class="date-timer-time-cell"
                [class.date-timer-time-cell-selected]="
                  (isSingleDate(selectedValue) && selectType === 'single' && selectedValue.getHours() === hour) || 
                  (isRangeValue(selectedValue) && selectType === 'single' && selectedValue.start && selectedValue.start.getHours() === hour) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'start' && selectedValue.start && selectedValue.start.getHours() === hour) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'end' && selectedValue.end && selectedValue.end.getHours() === hour)"
                [class.date-timer-time-cell-disabled]="isTimeDisabled('hour', hour)"
                (click)="onSelectHour(hour)">
              {{ hour < 10 ? '0' + hour : hour }}
            </li>
          </ul>
        </div>
        <!-- åˆ†é’Ÿ -->
        <div class="date-timer-time-column">
          <ul>
            <li *ngFor="let minute of minutes" 
                class="date-timer-time-cell"
                [class.date-timer-time-cell-selected]="
                  (isSingleDate(selectedValue) && selectType === 'single' && selectedValue.getMinutes() === minute) || 
                  (isRangeValue(selectedValue) && selectType === 'single' && selectedValue.start && selectedValue.start.getMinutes() === minute) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'start' && selectedValue.start && selectedValue.start.getMinutes() === minute) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'end' && selectedValue.end && selectedValue.end.getMinutes() === minute)"
                [class.date-timer-time-cell-disabled]="isTimeDisabled('minute', minute)"
                (click)="onSelectMinute(minute)">
              {{ minute < 10 ? '0' + minute : minute }}
            </li>
          </ul>
        </div>
        <!-- ç§’é’Ÿ -->
        <div class="date-timer-time-column">
          <ul>
            <li *ngFor="let second of seconds" 
                class="date-timer-time-cell"
                [class.date-timer-time-cell-selected]="
                  (isSingleDate(selectedValue) && selectType === 'single' && selectedValue.getSeconds() === second) || 
                  (isRangeValue(selectedValue) && selectType === 'single' && selectedValue.start && selectedValue.start.getSeconds() === second) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'start' && selectedValue.start && selectedValue.start.getSeconds() === second) || 
                  (isRangeValue(selectedValue) && selectType === 'range' && rangePart === 'end' && selectedValue.end && selectedValue.end.getSeconds() === second)"
                [class.date-timer-time-cell-disabled]="isTimeDisabled('second', second)"
                (click)="onSelectSecond(second)">
              {{ second < 10 ? '0' + second : second }}
            </li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- é¢å¤–é¡µè„š -->
    <div *ngIf="extraFooter" class="date-timer-footer-extra">
      <ng-container *ngIf="typeof extraFooter === 'string'">{{ extraFooter }}</ng-container>
      <ng-container *ngIf="typeof extraFooter !== 'string'">
        <!-- <ng-container *ngTemplateOutlet="extraFooter"></ng-container> -->
      </ng-container>
    </div>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="date-timer-footer" *ngIf="showTime || showToday">
      <div *ngIf="showTime" class="date-timer-time-display">
        <ng-container *ngIf="selectType === 'single' && isSingleDate(selectedValue)">
          {{ selectedValue.getHours() | number:'2.0-0' }}:{{ selectedValue.getMinutes() | number:'2.0-0' }}:{{ selectedValue.getSeconds() | number:'2.0-0' }}
        </ng-container>
        <ng-container *ngIf="selectType === 'single' && isRangeValue(selectedValue) && selectedValue.start">
          {{ selectedValue.start.getHours() | number:'2.0-0' }}:{{ selectedValue.start.getMinutes() | number:'2.0-0' }}:{{ selectedValue.start.getSeconds() | number:'2.0-0' }}
        </ng-container>
        <ng-container *ngIf="selectType === 'range' && isRangeValue(selectedValue)">
          <ng-container *ngIf="rangePart === 'start' && selectedValue.start">
            {{ selectedValue.start.getHours() | number:'2.0-0' }}:{{ selectedValue.start.getMinutes() | number:'2.0-0' }}:{{ selectedValue.start.getSeconds() | number:'2.0-0' }}
          </ng-container>
          <ng-container *ngIf="rangePart === 'end' && selectedValue.end">
            {{ selectedValue.end.getHours() | number:'2.0-0' }}:{{ selectedValue.end.getMinutes() | number:'2.0-0' }}:{{ selectedValue.end.getSeconds() | number:'2.0-0' }}
          </ng-container>
        </ng-container>
      </div>
      <div class="date-timer-footer-buttons">
        <button *ngIf="showToday && currentPanelMode !== 'time'" class="date-timer-now-btn" (click)="today()">ä»Šå¤©</button>
        <button *ngIf="showTime" class="date-timer-now-btn" (click)="setCurrentTime()">æ­¤åˆ»</button>
        <button class="date-timer-ok-btn" (click)="confirm()">ç¡®å®š</button>
      </div>
    </div>
  </div>
</ng-template> 