<div class="lib-table-wrapper">
  <!-- 加载中指示器 -->
  <div class="lib-table-loading" *ngIf="loading">
    <ng-container *ngIf="loadingIndicator; else defaultLoadingTpl">
      <ng-container *ngTemplateOutlet="loadingIndicator"></ng-container>
    </ng-container>
    <ng-template #defaultLoadingTpl>
      <div class="lib-table-loading-indicator">
        <div class="lib-table-loading-spinner"></div>
      </div>
    </ng-template>
  </div>

  <!-- 表格标题 -->
  <div class="lib-table-title" *ngIf="title">
    <ng-container *ngIf="!isTemplateRef(title)">{{ title }}</ng-container>
    <ng-container *ngIf="isTemplateRef(title)">
      <ng-container *ngTemplateOutlet="title"></ng-container>
    </ng-container>
  </div>

  <!-- 表格主体 -->
  <div class="lib-table"
    [class.lib-table-bordered]="bordered"
    [class.lib-table-small]="size === 'small'"
    [class.lib-table-middle]="size === 'middle'"
    [class.lib-table-fixed-header]="scroll?.y"
    [class.lib-table-fixed-left]="hasFixedLeft"
    [class.lib-table-fixed-right]="hasFixedRight">

    <div class="lib-table-container" 
      [ngStyle]="{
        'max-height': scroll?.y, 
        'overflow-y': scroll?.y ? 'auto' : null,
        'overflow-x': scroll?.x ? 'auto' : null,
        'width': '100%',
        'position': 'relative'
      }">
      <table [ngStyle]="{'min-width': scroll?.x || null, 'width': '100%'}">
        <!-- 表头 -->
        <thead class="lib-table-thead">
          <tr>
            <th *ngFor="let column of columns" 
                [style.textAlign]="column.align || 'left'"
                [style.width]="column.width || null"
                [class.lib-table-column-fixed-left]="column.fixed === 'left' || column.fixed === true"
                [class.lib-table-column-fixed-right]="column.fixed === 'right'"
                [style.position]="column.fixed || scroll?.y ? 'sticky' : null"
                [style.top]="scroll?.y ? '0' : null"
                [style.left]="(column.fixed === 'left' || column.fixed === true) ? getLeftPosition(column) : null"
                [style.right]="column.fixed === 'right' ? getRightPosition(column) : null"
                [style.z-index]="getZIndex(column)">
              <div class="lib-table-column-title">
                {{ column.title }}
                
                <!-- 排序按钮 -->
                <div class="lib-table-sorter" *ngIf="column.sortable">
                  <div class="lib-table-sorter-inner">
                    <span class="lib-table-sorter-up" 
                          [class.active]="column.sortOrder === 'ascend'"
                          (click)="onSortChange(column.field, column.sortOrder === 'ascend' ? null : 'ascend')">
                      <svg viewBox="0 0 1024 1024" width="1em" height="1em" fill="currentColor">
                        <path d="M858.9 689L530.5 308.2c-9.4-10.9-27.5-10.9-37 0L165.1 689c-12.2 14.2-1.2 35 18.5 35h656.8c19.7 0 30.7-20.8 18.5-35z"></path>
                      </svg>
                    </span>
                    <span class="lib-table-sorter-down" 
                          [class.active]="column.sortOrder === 'descend'"
                          (click)="onSortChange(column.field, column.sortOrder === 'descend' ? null : 'descend')">
                      <svg viewBox="0 0 1024 1024" width="1em" height="1em" fill="currentColor">
                        <path d="M840.4 300H183.6c-19.7 0-30.7 20.8-18.5 35l328.4 380.8c9.4 10.9 27.5 10.9 37 0L858.9 335c12.2-14.2 1.2-35-18.5-35z"></path>
                      </svg>
                    </span>
                  </div>
                </div>

                <!-- 过滤按钮 -->
                <div class="lib-table-filter" *ngIf="column.filterable">
                  <span class="lib-table-filter-icon" 
                        [class.active]="column.selectedFilters && column.selectedFilters.length > 0"
                        libPopover
                        [popoverContent]="filterContent"
                        [popoverPlacement]="'bottom'"
                        [popoverTrigger]="'click'"
                        [popoverVisible]="column.showFilterDropdown === true"
                        (popoverVisibleChange)="handleFilterVisibleChange(column, $event)">
                    <svg viewBox="64 64 896 896" focusable="false" data-icon="filter" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                      <path d="M349 838c0 17.7 14.2 32 31.8 32h262.4c17.6 0 31.8-14.3 31.8-32V642H349v196zm531.1-684H143.9c-24.5 0-39.8 26.7-27.5 48l221.3 376h348.8l221.3-376c12.1-21.3-3.2-48-27.7-48z"></path>
                    </svg>
                  </span>
                  
                  <!-- 过滤模板 -->
                  <ng-template #filterContent>
                    <div class="lib-table-filter-popover">
                      <ul class="lib-table-filter-popover-list">
                        <li *ngFor="let filter of column.filters" class="lib-table-filter-popover-item">
                          <label class="lib-table-filter-popover-item-label">
                            <input type="checkbox" 
                                   [checked]="isFilterChecked(column, filter.value)"
                                   (change)="onFilterItemChange(column, filter.value, $event)">
                            <span>{{ filter.text }}</span>
                          </label>
                        </li>
                      </ul>
                      <div class="lib-table-filter-popover-btns">
                        <button class="lib-table-filter-popover-link confirm" 
                                (click)="confirmFilter(column)">确定</button>
                        <button class="lib-table-filter-popover-link clear"
                                (click)="resetFilter(column)">重置</button>
                      </div>
                    </div>
                  </ng-template>
                </div>
              </div>
            </th>
          </tr>
        </thead>

        <!-- 表格内容 -->
        <tbody class="lib-table-tbody">
          <ng-container *ngIf="currentPageData.length > 0; else emptyTemplate">
            <tr *ngFor="let item of currentPageData; let i = index">
              <td *ngFor="let column of columns; let colIndex = index"
                  [style.textAlign]="column.align || 'left'"
                  [class.lib-table-column-fixed-left]="column.fixed === 'left' || column.fixed === true"
                  [class.lib-table-column-fixed-right]="column.fixed === 'right'"
                  [style.position]="column.fixed ? 'sticky' : null"
                  [style.left]="(column.fixed === 'left' || column.fixed === true) ? getLeftPosition(column) : null"
                  [style.right]="column.fixed === 'right' ? getRightPosition(column) : null"
                  [style.z-index]="1">
                <!-- 自定义单元格渲染 -->
                <ng-container *ngIf="isColumnWithCustomCell(column); else defaultCell">
                  <ng-container *ngTemplateOutlet="column.customCell; context: { $implicit: item, text: item[column.field], record: item, index: i }"></ng-container>
                </ng-container>
                <ng-template #defaultCell>
                  {{ item[column.field] }}
                </ng-template>
              </td>
            </tr>
          </ng-container>
          <ng-template #emptyTemplate>
            <tr>
              <td [attr.colspan]="columns.length" class="lib-table-empty">
                暂无数据
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <!-- 表格底部 -->
    <div class="lib-table-footer" *ngIf="footer">
      <ng-container *ngIf="!isTemplateRef(footer)">{{ footer }}</ng-container>
      <ng-container *ngIf="isTemplateRef(footer)">
        <ng-container *ngTemplateOutlet="footer"></ng-container>
      </ng-container>
    </div>

    <!-- 分页 -->
    <div class="lib-table-pagination" *ngIf="showPagination && total > 0">
      <div class="lib-pagination">
        <ul class="lib-pagination-list">
          <!-- 上一页 -->
          <li class="lib-pagination-prev" 
              [class.lib-pagination-disabled]="pageIndex === 1"
              (click)="pageIndex > 1 && onPageIndexChange(pageIndex - 1)">
            上一页
          </li>
          
          <!-- 页码 -->
          <ng-container *ngFor="let page of getPageNumbers()">
            <li class="lib-pagination-item" 
                [class.lib-pagination-item-active]="page === pageIndex"
                (click)="onPageIndexChange(page)">
              {{ page }}
            </li>
          </ng-container>
          
          <!-- 下一页 -->
          <li class="lib-pagination-next" 
              [class.lib-pagination-disabled]="pageIndex === getLastPage()"
              (click)="pageIndex < getLastPage() && onPageIndexChange(pageIndex + 1)">
            下一页
          </li>
          
          <!-- 每页条数选择器 -->
          <li class="lib-pagination-options">
            <select [value]="pageSize" (change)="onPageSizeChange(handleSelectChange($event))">
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }} 条/页</option>
            </select>
          </li>
          
          <!-- 跳转至 -->
          <li class="lib-pagination-jumper">
            跳至
            <input type="number" [value]="pageIndex" 
                   (keyup.enter)="onPageIndexChange(handleInputChange($event))"
                   min="1" [max]="getLastPage()">
            页
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
