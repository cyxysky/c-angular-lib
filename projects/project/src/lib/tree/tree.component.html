<div class="lib-tree-container">
  <!-- 空状态显示 -->
  <div class="lib-tree-empty-state" *ngIf="showEmptyState()">
    <i class="empty-icon"></i>
    <span class="empty-text">无搜索结果</span>
  </div>

  <!-- 树节点容器，使用虚拟滚动或普通滚动 -->
  <div 
    #treeContainer 
    class="lib-tree-node-container" 
    [class.lib-tree-with-lines]="showLine"
    [class.lib-tree-hidden]="showEmptyState()"
  >
    <!-- 非虚拟滚动模式 -->
    <ng-container *ngIf="!isVirtualScroll">
      <ng-container *ngTemplateOutlet="renderTreeNodesTemplate; context: { $implicit: treeData, level: 0 }"></ng-container>
    </ng-container>

    <!-- 虚拟滚动模式 -->
    <cdk-virtual-scroll-viewport
      *ngIf="isVirtualScroll"
      [style.height.px]="virtualHeight"
      [itemSize]="optionHeight"
      class="virtual-scroll-viewport"
    >
      <ng-container *cdkVirtualFor="let node of treeData; let isLast = last">
        <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: node, isLast: isLast, level: 0 }"></ng-container>
      </ng-container>
    </cdk-virtual-scroll-viewport>
  </div>
</div>

<!-- 树节点模板 -->
<ng-template #renderTreeNodesTemplate let-nodes let-level="level">
  <ul class="lib-tree-node-list">
    <li *ngFor="let node of nodes; let isLast = last; let index = index" class="lib-tree-node" [class.lib-tree-node-hidden]="!isNodeVisible(node)" [class.lib-tree-node-last]="isLast">
      <div 
        class="lib-tree-node-content"
        [class.lib-tree-node-content-selected]="node.selected"
        [class.lib-tree-node-content-disabled]="node.disabled"
        [style.height]="optionHeight + 'px'"
      >
        <!-- 缩进 -->
        <ng-container *ngTemplateOutlet="indentTemplate; context: { $implicit: node, isLast: isLast, level: level, index: index, parentLength: nodes.length }"></ng-container>
        <!-- 展开/折叠图标 -->
        <ng-container *ngTemplateOutlet="switcherTemplate; context: { $implicit: node, level: level }"></ng-container>
        <!-- 复选框 -->
        <ng-container *ngTemplateOutlet="checkboxTemplate; context: { $implicit: node, level: level }"></ng-container>
        <!-- 自定义图标或默认图标 -->
        <span 
          *ngIf="showIcon" 
          class="lib-tree-icon"
        >
          <ng-container *ngIf="iconTemplate; else defaultIconTpl">
            <ng-container *ngTemplateOutlet="iconTemplate; context: { $implicit: node, origin: node }"></ng-container>
          </ng-container>
          <ng-template #defaultIconTpl>
            <i class="tree-icon" [ngClass]="node.icon || (node.isLeaf ? 'file-icon' : (expandedKeys.has(node.key) ? 'folder-open-icon' : 'folder-icon'))"></i>
          </ng-template>
        </span>
        <!-- 节点内容 -->
        <div class="lib-tree-title" [class.lib-tree-title-disabled]="node.disabled" [class.lib-tree-title-selected]="node.selected" (click)="onNodeSelect(node, $event)">
          <ng-container *ngIf="treeTemplate; else defaultNodeTpl">
            <ng-container *ngTemplateOutlet="treeTemplate; context: { $implicit: node, origin: node, node: node }"></ng-container>
          </ng-container>
          <ng-template #defaultNodeTpl>
            {{ node.title }}
          </ng-template>
        </div>
      </div>

      <!-- 子节点递归 -->
      <div class="lib-tree-children" *ngIf="node.children && node.children.length && expandedKeys.has(node.key)">
        <ng-container *ngTemplateOutlet="renderTreeNodesTemplate; context: { $implicit: node.children, level: level + 1 }"></ng-container>
      </div>
    </li>
  </ul>
</ng-template>

<!-- 单个节点模板 -->
<ng-template #nodeTemplate let-node let-isLast="isLast" let-level="level">
  <li class="lib-tree-node-list" [class.lib-tree-node-hidden]="!isNodeVisible(node)" [class.lib-tree-node-last]="isLast">
    <div 
      class="lib-tree-node-content"
      [class.lib-tree-node-content-selected]="node.selected"
      [class.lib-tree-node-content-disabled]="node.disabled"
      [style.height.px]="optionHeight"
    >
    <!-- 缩进 -->
    <ng-container *ngTemplateOutlet="indentTemplate; context: { $implicit: node, isLast: isLast, level: level }"></ng-container>
    <!-- 展开/折叠图标 -->
    <ng-container *ngTemplateOutlet="switcherTemplate; context: { $implicit: node, level: level }"></ng-container>
    <!-- 复选框 -->
    <ng-container *ngTemplateOutlet="checkboxTemplate; context: { $implicit: node, level: level }"></ng-container>
    <!-- 节点内容 -->
    <div class="lib-tree-title" 
        [class.lib-tree-title-disabled]="node.disabled" 
        [class.lib-tree-title-selected]="node.selected" 
        (click)="onNodeSelect(node, $event)">
        {{ node.title }}
    </div>
    </div>

    <!-- 子节点 -->
    <div class="lib-tree-children" *ngIf="node.children?.length && expandedKeys.has(node.key)">
      <ng-container *ngFor="let childNode of node.children; let isLastChild = last">
        <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: childNode, isLast: isLastChild, level: level + 1 }"></ng-container>
      </ng-container>
    </div>
  </li>
</ng-template>

<!-- 展开/折叠图标 -->
<ng-template #switcherTemplate let-node let-level="level">
    <!-- 有子节点的 -->
    <span 
    *ngIf="node.children && node.children.length || (asyncData && !node.isLeaf)"
    class="lib-tree-switcher"
    [class.lib-tree-flat-line]="showLine && level !== 0"
    [class.lib-tree-switcher-expanded]="expandedKeys.has(node.key)"
    [class.lib-tree-switcher-disabled]="node.disabled"
    (click)="$event.stopPropagation(); onNodeExpand(node)"
  >
    <i class="tree-switcher-icon"></i>
  </span>
  <!-- 没有子节点的 -->
  <span 
    *ngIf="!node.children || (!node.children.length && !asyncData) || node.isLeaf" class="lib-tree-switcher" 
    [class.lib-tree-flat-line-longer]="showLine">

  </span>
</ng-template>

<!-- 缩进 -->
<ng-template #indentTemplate let-node let-isLast="isLast" let-level="level" let-index="index" let-parentLength="parentLength">
    <span 
    [style.width.px]="indent"
    [class.lib-tree-vertical-line]="showLine && hasFlatLine(node, level, j)"
    class="lib-tree-indent" 
    *ngFor="let i of getIndentArray(level);index as j">
    </span>
</ng-template>

<!-- 复选框 -->
<ng-template #checkboxTemplate let-node>
    <span 
        *ngIf="checkable" 
        class="lib-tree-checkbox" 
        [class.lib-tree-checkbox-checked]="node.checked"
        [class.lib-tree-checkbox-indeterminate]="node.indeterminate"
        [class.lib-tree-checkbox-disabled]="node.disabled || node.disableCheckbox"
        (click)="$event.stopPropagation(); onNodeCheck(node, !node.checked)"
      >
        <span class="lib-tree-checkbox-inner"></span>
      </span>
</ng-template>