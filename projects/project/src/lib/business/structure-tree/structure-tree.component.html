<!-- 组织架构树组件 -->
<div class="structure-tree-container">
    <ng-container *ngIf="data && data.length; else noData">
        <div class="structure-tree">
            <ng-container *ngTemplateOutlet="nodeTemplate; context: {nodes: data, level: 0}"></ng-container>
        </div>
    </ng-container>
    <ng-template #noData>
        <div class="structure-tree-empty">暂无数据</div>
    </ng-template>
    <!-- 节点模板 -->
    <ng-template #nodeTemplate let-nodes="nodes" let-level="level" let-parent="parent">
        <div class="tree-level">
            <!-- 每个节点 -->
            <div class="tree-node-wrapper" *ngFor="let node of nodes; let i=index; let isLast=last">
                <!-- 节点卡片 -->
                <div *ngIf="parent && getWidth(node.__key, level) && getWidth(node.__key, level) < 5">
                    <div 
                        class="vertical-connector" 
                        [style.height]="this.getHeight(node.__key) + 'px'"
                        [style.top]="-this.getHeight(node.__key) + 'px'"
                        >
                    </div>
                </div>
                <div class="node-card">
                    <!-- 连接线 -->

                    <!-- 节点圆点 -->
                    <div [id]="node.__key + 'top'" *ngIf="parent && parent.children && parent.children.length" class="circle-point point-top">
                        <div 
                            *ngIf="getWidth(node.__key, level) && getWidth(node.__key, level) > 5"
                            class="line-wrap-box"
                            [style.height]="getHeight(node.__key) + 'px'"
                            [style.top]="(-getHeight(node.__key) / 2) + 'px'"
                            [style.width]="getWidth(node.__key, level) + 'px'"
                            [style.left]="getDirection(node.__key) === 'L' ? (-getWidth(node.__key, level) + 2 + 'px') : '0px'">
                            <div style="position: relative;pointer-events: none;">
                                <div *ngIf="getDirection(node.__key) === 'L'" class="line-wrapper-bottom-right" [style.border-bottom-left-radius]="lineRadius"></div>
                                <div *ngIf="getDirection(node.__key) === 'R'" class="line-wrapper-bottom" [style.border-top-left-radius]="lineRadius"></div>
                            </div>
                            <div style="position: relative;pointer-events: none;">
                                <div *ngIf="getDirection(node.__key) === 'L'" class="line-wrapper-top-right" [style.border-top-right-radius]="lineRadius"></div>
                                <div *ngIf="getDirection(node.__key) === 'R'" class="line-wrapper-top" [style.border-bottom-right-radius]="lineRadius"></div>
                            </div>
                    </div>
                    </div>

                    <ng-container *ngTemplateOutlet="nodeTemplates || defaultNodeTemplate; context: {$implicit : node, level: level}"></ng-container>
                    <ng-template #defaultNodeTemplate let-node>
                        <div class="node-content" (click)="onNodeClick(node)">
                            <div class="node-avatar">
                                <img *ngIf="node.avatar" [src]="node.avatar" alt="avatar" />
                                <div *ngIf="!node.avatar" class="default-avatar">{{ node.name?.charAt(0) }}</div>
                            </div>
                            <div class="node-info">
                                <div class="node-name">{{ node.name }}</div>
                                <div class="node-title">{{ node.title }}</div>
                            </div>
                            <div class="node-value">{{ node.value }}</div>
                        </div>
                    </ng-template>
                    <!-- 子节点圆点 -->
                    <div [id]="node.__key + 'bottom'" *ngIf="node.children && node.children.length" class="circle-point point-bottom"></div>
                </div>

                <!-- 连接线和子节点 -->
                <div class="tree-children" *ngIf="node.children && node.children.length && node.showChildren">
                    <!-- 顶部垂直连接器 -->
                    <div class="connector-wrapper" *ngIf="node.children && node.children.length === 1">
                        <div class="vertical-connector"></div>
                    </div>

                    <div class="children-container">
                        <!-- 递归渲染子节点 -->
                        <ng-container *ngTemplateOutlet="nodeTemplate; context: {nodes: node.children, level: level + 1, parent: node}"></ng-container>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
</div>


<ng-template #defaultNodeTemplate let-node
></ng-template>