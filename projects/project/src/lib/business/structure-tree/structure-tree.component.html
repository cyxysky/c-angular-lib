<!-- 组织架构树组件 -->
<div class="structure-tree-container">
    <ng-container *ngIf="data && data.length; else noData">
        <div class="structure-tree">
            <ng-container *ngTemplateOutlet="nodeTemplate; context: {nodes: data, level: 0}"></ng-container>
        </div>
    </ng-container>

    <ng-template #noData>
        <div class="structure-tree-empty">暂无数据</div>
    </ng-template>

    <!-- 节点模板 -->
    <ng-template #nodeTemplate let-nodes="nodes" let-level="level" let-parent="parent">
        <div class="tree-level">
            <!-- 每个节点 -->
            <div class="tree-node-wrapper" *ngFor="let node of nodes; let i=index; let isLast=last">
                <!-- 节点卡片 -->

                <div class="connector-wrapper" *ngIf="getLengthToParentNode(parent?.children?.length, i).number === 0">
                    <div class="vertical-connector"></div>
                </div>
                <div class="node-card">
                    <div *ngIf="getLengthToParentNode(parent?.children?.length, i).absNumber !== 0"
                        class="line-wrap-box"
                        [style.width]="getLengthToParentNode(parent?.children?.length, i).absNumber * 161 + 'px'"
                        [style.left]="getLeft(parent?.children?.length, i)">
                        <div
                            [ngClass]="getPosition(parent?.children?.length, i) ? 'line-wrapper-bottom-right': 'line-wrapper-bottom'">
                        </div>
                        <div
                            [ngClass]="getPosition(parent?.children?.length, i) ? 'line-wrapper-top-right': 'line-wrapper-top'">
                        </div>
                    </div>
                    <div *ngIf="parent && parent.children && parent.children.length" class="circle-point point-top">
                    </div>
                    <div class="node-content" (click)="onNodeClick(node)">
                        <div class="node-avatar">
                            <img *ngIf="node.avatar" [src]="node.avatar" alt="avatar" />
                            <div *ngIf="!node.avatar" class="default-avatar">{{ node.name?.charAt(0) }}</div>
                        </div>
                        <div class="node-info">
                            <div class="node-name">{{ node.name }}</div>
                            <div class="node-title">{{ node.title }}</div>
                        </div>
                        <div class="node-value">{{ node.value }}</div>
                    </div>
                    <div *ngIf="node.children && node.children.length" class="circle-point point-bottom"></div>
                </div>

                <!-- 连接线和子节点 -->
                <div class="tree-children" *ngIf="node.children && node.children.length">
                    <!-- 顶部垂直连接器 -->
                    <div class="connector-wrapper" *ngIf="node.children && node.children.length === 1">
                        <div class="vertical-connector"></div>
                    </div>

                    <div class="children-container">
                        <!-- 递归渲染子节点 -->
                        <ng-container
                            *ngTemplateOutlet="nodeTemplate; context: {nodes: node.children, level: level + 1, parent: node}"></ng-container>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
</div>