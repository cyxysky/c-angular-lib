<lib-select-box 
    (click)="openDropdown()" 
    cdkOverlayOrigin
    [selectMode]="isMultiple ? 'multiple' : 'single'"
    [loading]="loading"
    [size]="size"
    [borderless]="borderless"
    [disabled]="disabled"
    [placeholder]="placeholder"
    [status]="status"
    [isActive]="isDropdownOpen"
    [optionLabelTemplate]="optionLabelTemplate"
    [getLabel]="getLabel"
    [(searchValue)]="searchValue"
    [data]="!isMultiple ? displayLabels : displayTags"
    #searchInput
    (clear)="clear()"
    (remove)="removeItem($event.value)"
    (search)="onSearch($event)"
    (inputWidthChange)="asyncUpdateDropdownPosition()">
</lib-select-box>

<!-- 下拉菜单 -->
<ng-template #dropdownTemplate>
    <div class="cascader-dropdown"
        (mouseenter)="enterDropdown()"
        (mouseleave)="leaveDropdown()"
        [class.open]="isDropdownOpen" 
        [class.closed]="!isDropdownOpen"
        [style.min-width]="menuWidth + 'px'">
        <!-- 搜索结果列表 -->
        <div *ngIf="showSearch && searchValue" class="search-result-list">
            <div *ngIf="loading" class="search-loading">
                <div class="loading-text">搜索中...</div>
            </div>
            <div *ngIf="!loading && filteredOptions.length === 0" class="empty-options">
                <div class="empty-container">
                    <div>
                        <i class="bi-archive"></i>
                    </div>
                    <div class="empty-text">暂无匹配数据</div>
                </div>
            </div>
            <div *ngIf="!loading && filteredOptions.length > 0" class="search-options">
                <ng-container *ngFor="let option of filteredOptions; index as i" >
                    <div 
                        *ngIf="!isMultiple ? isLeaf(option) : true"
                        class="search-option"
                        [class.disabled]="option.disabled"
                        [class.selected]="option.checked"
                        [class.keyboard-active]="keyboardNavIndex === i"
                        (click)="onSearchOptionClick(option)">
                        <div class="option-path">
                            <ng-container *ngIf="optionLabelTemplate">
                                <ng-container *ngTemplateOutlet="optionLabelTemplate; context: {$implicit: option, index: i, path: option.path}"></ng-container>
                            </ng-container>
                            <ng-container *ngIf="!optionLabelTemplate">
                                {{ getOptionPath(option) }}
                            </ng-container>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
        
        <!-- 级联菜单 -->
        <div *ngIf="!searchValue" class="cascader-menus">
            <!-- 级别菜单 -->
            <ul *ngFor="let column of columns; index as i" class="cascader-menu">
                <ng-container *ngIf="column && column.length > 0; else emptyMenu">
                    <!-- 当前级别菜单的选项 -->
                    <li *ngFor="let option of column; index as j" 
                        class="cascader-menu-item" 
                        [class.cascader-menu-item-active]="isOptionActivated(option, i)"
                        [class.cascader-menu-item-disabled]="option.disabled"
                        [class.cascader-menu-item-selected]="isOptionTempSelected(option, i)"
                        [class.cascader-menu-item-loading]="option.loading"
                        (click)="onOptionClick(option, i, $event)"
                        (mouseenter)="onOptionMouseEnter(option, i)">
                        <div class="cascader-menu-item-content">
                            <!-- 复选框 -->
                            <ng-container *ngIf="isMultiple && checkable">
                                <lib-checkbox 
                                    *ngIf="checkable"
                                    [ngModel]="option.checked"
                                    [checkboxSingle]="true"
                                    [checkboxIndeterminate]="option.halfChecked" 
                                    [checkboxDisabled]="option.disabled || option.disableCheckbox"
                                    [checkboxSingleLabel]="''"
                                    (click)="onCheckboxClick(option, i, $event)">
                                </lib-checkbox>
                            </ng-container>
                            
                            <!-- 标签 -->
                            <span class="cascader-menu-item-label">
                                <ng-container *ngIf="optionTemplate">
                                    <ng-container *ngTemplateOutlet="optionTemplate; context: {$implicit: option, index: j, level: i}"></ng-container>
                                </ng-container>
                                <ng-container *ngIf="!optionTemplate">
                                    {{ option[labelProperty] }}
                                </ng-container>
                            </span>
                            
                            <!-- 加载图标 -->
                            <span *ngIf="option.loading" class="cascader-menu-item-loading-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 16 16" class="loading-svg">
                                    <path d="M8 0a8 8 0 0 1 8 8h-2A6 6 0 0 0 8 2V0z" />
                                </svg>
                            </span>
                            
                            <!-- 子项指示器 -->
                            <span *ngIf="hasChildren(option)" class="cascader-menu-item-expand-icon">
                                <i class="bi bi-chevron-right"></i>
                            </span>
                        </div>
                    </li>
                </ng-container>
                
                <ng-template #emptyMenu>
                    <li class="cascader-menu-item-empty">
                        <span>暂无数据</span>
                    </li>
                </ng-template>
            </ul>
        </div>
    </div>
</ng-template>
