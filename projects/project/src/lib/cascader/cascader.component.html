<div class="cascader-box" 
    [class.cascader-sm]="size === 'small'" 
    [class.cascader-lg]="size === 'large'"
    [class.cascader-borderless]="borderless" 
    [class.cascader-error]="status === 'error'"
    [class.cascader-warning]="status === 'warning'" 
    [class.cascader-disabled]="disabled"
    [class.cascader-open]="isDropdownOpen"
    (click)="openDropdown()" 
    [style.min-width]="'200px'" 
    cdkOverlayOrigin>
    <!-- 内容 -->
    <div class="cascader-content">
        <!-- 占位符 -->
        <div class="placeholder" *ngIf="showPlaceHolder()">
            {{ placeholder }}
        </div>
        <!-- 单选数据 -->
        <div class="cascader-labels" *ngIf="showSingalData()">
            <span class="label-text" [ngClass]="{'dropdown-open-text': isNowDropdownOpen}">{{ displayLabels.join(' / ') }}</span>
        </div>
        <!-- 多选数据 -->
        <ng-container *ngIf="showMultData()">
            <lib-select-tag *ngFor="let tag of displayTags" (remove)="removeItem($event, tag.value)" [size]="size" [closable]="true">
                {{ tag.label }}
            </lib-select-tag>
        </ng-container>
        <!-- 搜索框 -->
        <lib-select-search
            #searchInput
            *ngIf="showSearch"
            [disabled]="disabled"
            (inputWidthChange)="updateDropdownPosition()"
            (compositionChange)="onCompositionChange($event)"
            (search)="onSearch($event)">
        </lib-select-search>
    </div>
    <!-- 后缀 -->
    <ng-container *ngTemplateOutlet="suffixTemplate"></ng-container>
</div>

<!-- 后缀模板 -->
<ng-template #suffixTemplate>
    <!-- 后缀图标 -->
    <div class="suffix-box">
        <!-- 加载图标 -->
        <div *ngIf="loading" class="loading-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="loading-svg" color="rgba(23, 184, 199, 0.6)" fill="currentColor">
                <path d="M8 0a8 8 0 0 1 8 8h-2A6 6 0 0 0 8 2V0z" />
            </svg>
        </div>
        <!-- 搜索图标 -->
        <i class="bi bi-search" *ngIf="!loading && showSearch && isDropdownOpen"></i>
        <!-- 下拉图标 -->
        <i class="bi bi-caret-down-fill cascader-icon" *ngIf="!loading && !showSearch" [style.transform]="isDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)'"></i>
        <!-- 清除图标 -->
        <i class="bi-x-circle-fill clear-icon" *ngIf="allowClear && !loading && !isDropdownOpen" (click)="clear($event)"></i>
    </div>
</ng-template>

<!-- 下拉菜单 -->
<ng-template #dropdownTemplate>
    <div class="cascader-dropdown"
        (mouseenter)="enterDropdown()"
        (mouseleave)="leaveDropdown()"
        [class.open]="isDropdownOpen" 
        [class.closed]="!isDropdownOpen"
        [style.min-width]="menuWidth + 'px'">
        <!-- 搜索结果列表 -->
        <div *ngIf="showSearch && searchValue" class="search-result-list">
            <div *ngIf="loading" class="search-loading">
                <div class="loading-text">搜索中...</div>
            </div>
            <div *ngIf="!loading && filteredOptions.length === 0" class="empty-options">
                <div class="empty-container">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                        </svg>
                    </div>
                    <div class="empty-text">暂无匹配数据</div>
                </div>
            </div>
            <div *ngIf="!loading && filteredOptions.length > 0" class="search-options">
                <ng-container *ngFor="let option of filteredOptions; index as i" >
                    <div 
                        *ngIf="!isMultiple ? isLeaf(option) : true"
                        class="search-option"
                        [class.disabled]="option.disabled"
                        [class.selected]="option.checked"
                        [class.keyboard-active]="keyboardNavIndex === i"
                        (click)="onSearchOptionClick(option)">
                        <div class="option-path">
                            <ng-container *ngIf="optionLabelTemplate">
                                <ng-container *ngTemplateOutlet="optionLabelTemplate; context: {$implicit: option, index: i, path: option.path}"></ng-container>
                            </ng-container>
                            <ng-container *ngIf="!optionLabelTemplate">
                                {{ getOptionPath(option) }}
                            </ng-container>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
        
        <!-- 级联菜单 -->
        <div *ngIf="!searchValue" class="cascader-menus">
            <!-- 级别菜单 -->
            <ul *ngFor="let column of columns; index as i" class="cascader-menu">
                <ng-container *ngIf="column && column.length > 0; else emptyMenu">
                    <!-- 当前级别菜单的选项 -->
                    <li *ngFor="let option of column; index as j" 
                        class="cascader-menu-item" 
                        [class.cascader-menu-item-active]="isOptionActivated(option, i)"
                        [class.cascader-menu-item-disabled]="option.disabled"
                        [class.cascader-menu-item-selected]="isOptionTempSelected(option, i)"
                        [class.cascader-menu-item-loading]="option.loading"
                        (click)="onOptionClick(option, i, $event)"
                        (mouseenter)="onOptionMouseEnter(option, i)">
                        <div class="cascader-menu-item-content">
                            <!-- 复选框 -->
                            <ng-container *ngIf="isMultiple && checkable">
                                <lib-checkbox 
                                    *ngIf="checkable"
                                    [ngModel]="option.checked"
                                    [checkboxSingle]="true"
                                    [checkboxIndeterminate]="option.halfChecked" 
                                    [checkboxDisabled]="option.disabled || option.disableCheckbox"
                                    [checkboxSingleLabel]="''"
                                    (click)="onCheckboxClick(option, i, $event)">
                                </lib-checkbox>
                            </ng-container>
                            
                            <!-- 标签 -->
                            <span class="cascader-menu-item-label">
                                <ng-container *ngIf="optionTemplate">
                                    <ng-container *ngTemplateOutlet="optionTemplate; context: {$implicit: option, index: j, level: i}"></ng-container>
                                </ng-container>
                                <ng-container *ngIf="!optionTemplate">
                                    {{ option[labelProperty] }}
                                </ng-container>
                            </span>
                            
                            <!-- 加载图标 -->
                            <span *ngIf="option.loading" class="cascader-menu-item-loading-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 16 16" class="loading-svg">
                                    <path d="M8 0a8 8 0 0 1 8 8h-2A6 6 0 0 0 8 2V0z" />
                                </svg>
                            </span>
                            
                            <!-- 子项指示器 -->
                            <span *ngIf="hasChildren(option)" class="cascader-menu-item-expand-icon">
                                <i class="bi bi-chevron-right"></i>
                            </span>
                        </div>
                    </li>
                </ng-container>
                
                <ng-template #emptyMenu>
                    <li class="cascader-menu-item-empty">
                        <span>暂无数据</span>
                    </li>
                </ng-template>
            </ul>
        </div>
    </div>
</ng-template>
