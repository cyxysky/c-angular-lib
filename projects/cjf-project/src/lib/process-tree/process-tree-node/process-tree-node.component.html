<ng-content></ng-content>
<div [ngClass]="data.numberType === NodeNumberType.BRANCH ? 'branch-node-children-node' : ''">
  <div 
    class="node-box"
    [style.padding-top]="data.type === NodeType.ROOT ? '0px' : (data.numberType === NodeNumberType.BRANCHS ? '5px' : '')"
    [style.padding-bottom]="data.type === NodeType.END ? '0px' : ''">
    <!-- 节点箭头 -->
    <div *ngIf="data.numberType !== NodeNumberType.BRANCHS && data.type !== NodeType.ROOT" class="arrows"></div>
    <!-- 分支节点添加按钮，配置需要修改内容 -->
    <ng-container *ngIf="data.numberType === NodeNumberType.BRANCHS">
      <div>
        <div class="branchs-node-add-button" (click)="add('addBranch')" *ngIf="data.type !== NodeType.END">
          添加条件分支
        </div>
        <div class="end-node" *ngIf="data.type === NodeType.END">
          结束
        </div>
      </div>
    </ng-container>
    <!-- 节点内容，配置需要修改内容 -->
    <ng-container *ngIf="data.numberType !== NodeNumberType.BRANCHS">
      <!-- 用于去除边框的横线，配置需要修改内容 -->
      <ng-container *ngIf="data.numberType === NodeNumberType.BRANCH">
        <ng-container *ngIf="branchIndex === 0">
          <div class="line-top-left"></div>
          <div class="line-bot-left"></div>
        </ng-container>
        <ng-container *ngIf="branchIndex === 1">
          <div class="line-top-right"></div>
          <div class="line-bot-right"></div>
        </ng-container>
      </ng-container>
      <!-- 流程节点内容 -->
      <div (wheel)="onChildWheel($event)">
        <!-- 对整个卡片内容进行渲染 -->
        <ng-container *ngIf="data.template && tableSource.get(data.template)">
          <div class="template-nodes-card-box">
            <ng-container [ngTemplateOutlet]="tableSource.get(data.template)"
              [ngTemplateOutletContext]="{$implicit : data , subject:subject}">
            </ng-container>
            <!-- 复制icon -->
            <!-- <div class="template-node-herder-copy-icon" (click)="add('copy')" *ngIf="data.numberType === NodeNumberType.BRANCH">
              <span qzIcon2
                qzIconName="icon-copy" 
                [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : ''"></span>
            </div> -->
            <!-- 关闭icon -->
            <div class="template-node-herder-close-icon" (click)="add('delete')" *ngIf="data.type !== NodeType.ROOT">
              <span qzIcon2 
                qzIconName="icon-Delete-Fill" 
                [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : ''">
              </span>
            </div>
            <!-- 选择icon -->
            <div class="template-node-herder-edit-icon" (click)="add('select')" >
              <span qzIcon2 
                qzIconName="icon-Edit-Fill" 
                [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : ''">
              </span>
            </div>
          </div>
        </ng-container>
        <!-- 默认流程节点内容 -->
        <div 
          *ngIf="!(data.template && tableSource.get(data.template))"
          (click)="data['error'] = true"
          class="nodes-card" 
          [ngClass]="{'error-border' : data.error}"
          [style.box-shadow]="(selectedNodeID === data.id && !data.error) ? '0px 0px 0px 2px #01CFE2' : ''">
          <!-- 错误icon图标 -->
          <ng-container *ngIf="data.error">
            <div
              qzIcon2
              qzIconName="icon-Fail-Fill"
              qzIconColor="gradients-red"
              class="err-icon"
              qzTooltip
              [qzTooltipContent]="data.errorMessage"
              qzTooltipPosition="right">
            </div>
          </ng-container>
          <ng-container>
            <!-- 头部 -->
            <div
              *ngIf="data.hasHeader !== undefined ? data.hasHeader : true"
              [style.background]="data.headerConfig && data.headerConfig.backgroundColor ? data.headerConfig.backgroundColor : 'white'"
              class="nodes-card-header"
              [ngClass]="{'error-header' : data.error && data.numberType !== NodeNumberType.BRANCH}">
              <div class="header-content">
                <ng-container
                  [ngTemplateOutlet]="data.headerConfig && data.headerConfig.template && tableSource.get(data.headerConfig.template) ? tableSource.get(data.headerConfig.template) : headerDefault"
                  [ngTemplateOutletContext]="{$implicit : data}">
                </ng-container>
              </div>
              <!-- 复制icon -->
              <!-- <div class="header-icon" (click)="add('copy')" *ngIf="data.numberType === NodeNumberType.BRANCH">
                <span qzIcon2 
                  qzIconName="icon-copy" 
                  *ngIf="data.type !== 'endNode'"
                  [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                  [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : qzIconColor"></span>
              </div> -->
              <!-- 编辑 -->
              <div class="header-icon" (click)="add('select')">
                <span 
                  qzIcon2 
                  qzIconName="icon-Edit-Fill" 
                  [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                  [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : ''">
                </span>
              </div>
              <!-- 删除icon -->
              <div *ngIf="data.type !== NodeType.ROOT" class="header-icon" (click)="add('delete')">
                <span 
                  *ngIf="data.type !== 'endNode'"
                  qzIcon2 
                  qzIconName="icon-Delete-Fill" 
                  [qzIconSize]="data.headerConfig && data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
                  [qzIconColor]="data.headerConfig && data.headerConfig.iconColor ? data.headerConfig.iconColor : qzIconColor">
                </span>
              </div>
            </div>
            <!-- 节点卡片内容 -->
            <div *ngIf="data.hasBody !== undefined ? data.hasBody : true" class="nodes-card-body">
              <!-- 多分支节点左移动按钮 -->
              <!-- <div class="nodes-card-body-move-left" (click)="add('move', -1)" *ngIf="(branchIndex === 1 || branchIndex === -1) && data.type !== 'endNode'">
                <div class="move-icon">
                  <span qzIcon2 [qzIconName]="'icon-Left-Outline'" qzIconSize="30"></span>
                </div>
              </div> -->
              <!-- node内容 (click)="add('select')" -->
              <div class="nodes-card-body-content" >
                <div>
                  <ng-container
                    [ngTemplateOutlet]="data.bodyConfig && data.bodyConfig.template && tableSource.get(data.bodyConfig.template) ? tableSource.get(data.bodyConfig.template) :  bodyDefault"
                    [ngTemplateOutletContext]="{$implicit : data}">
                  </ng-container>
                </div>
              </div>
              <!-- 多分支节点右移动按钮 -->
              <!-- <div class="nodes-card-body-move-right" (click)="add('move', 1)" *ngIf="(branchIndex === 0 || branchIndex === -1) && data.type !== 'endNode'">
                <div class="move-icon">
                  <span qzIcon2 [qzIconName]="'icon-Right-Outline'" qzIconSize="30"></span>
                </div>
              </div> -->
            </div>
            <!-- 底部 -->
            <div class="nodes-card-footer" *ngIf="data.hasFooter !== undefined ? data.hasFooter : true">
              <ng-container
                [ngTemplateOutlet]="data.footerConfig && data.footerConfig.template && tableSource.get(data.footerConfig.template) ? tableSource.get(data.footerConfig.template) :  footDefault"
                [ngTemplateOutletContext]="{$implicit : data}">
              </ng-container>
            </div>
          </ng-container>
        </div>
        <!-- 添加节点按钮 -->
        <div class="add-node-button-box">
          <div class="add-node-button" [qzDropDownMenu]="addTemplate" qzTrigger="click" qzPositions="right" tabindex="1">
            <span 
              *ngIf="data.type !== 'endNode'"
              qzIcon2
              class="add-node-button-icon"
              [qzIconName]="qzAddNodeIconName" 
              [qzIconSize]="qzAddNodeIconSize">
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<!-- 子级节点，单一节点 -->
<div *ngIf="notEmpty(data.children) && !data.branchs" class="children-node-tree">
  <qz-domp-process-tree-node [data]="data.children" [subject]="subject" [addNodeConfig]="addNodeConfig" [selectedNodeID]="selectedNodeID"></qz-domp-process-tree-node>
</div>

<!-- 分支节点，多层级节点 -->
<div *ngIf="data.branchs" class="branch-node-tree">
  <ng-container *ngFor="let item of data.branchs;index as i">
    <qz-domp-process-tree-node 
      [ngClass]="data.type !== NodeType.END? 'branch-node-children-box' : 'branch-node-end-box'" 
      [data]="item" 
      [subject]="subject" 
      [addNodeConfig]="addNodeConfig"
      [selectedNodeID]="selectedNodeID"
      [branchIndex]="i === 0 ? 0 : i === data.branchs.length-1 ? 1 : -1">
      <div *ngIf="i === 0" class="line-top-left"></div>
      <div *ngIf="i === 0" class="line-bot-left"></div>
      <div *ngIf="i === data.branchs.length-1" class="line-top-right"></div>
      <div *ngIf="i === data.branchs.length-1" class="line-bot-right"></div>
    </qz-domp-process-tree-node>
  </ng-container>
</div>

<!-- 分支节点结束 -->
<div *ngIf="data.branchs">
  <div *ngIf="data.type !== NodeType.END" class="branchs-node-end-add-button-box">
    <div class="add-node-button" [qzDropDownMenu]="addTemplates" qzTrigger="click" qzPositions="right" tabindex="2">
      <span 
        *ngIf="data.type !== NodeType.END"
        qzIcon2
        class="add-node-button-icon"
        [qzIconName]="qzAddNodeIconName" 
        [qzIconSize]="qzAddNodeIconSize">
      </span>
    </div>
    <!-- 添加节点按钮 -->
    <div *ngIf="notEmpty(data.children)">
      <qz-domp-process-tree-node [data]="data.children" [subject]="subject" [addNodeConfig]="addNodeConfig" [selectedNodeID]="selectedNodeID"></qz-domp-process-tree-node>
    </div>
  </div>
</div>

<!-- 结束节点 -->
<div *ngIf="hasEndNode">
  <div class="node-box" style="padding-bottom: 0px;">
    <div class="arrows"></div>
    <div class="end-node">
      结束
    </div>
  </div>
</div>

<!-- 头部默认的模板 -->
<ng-template #headerDefault let-data>
  <div class="default-header">
    <div class="default-header-content">
      <!-- 对应的icon -->
      <span class="default-header-content-icon" 
        *ngIf="data.headerConfig && data.headerConfig.icon" 
        qzIcon2
        [qzIconName]="data.headerConfig.icon"
        [qzIconSize]="data.headerConfig.iconSize ? data.headerConfig.iconSize : qzIconSize"
        [qzIconColor]="data.headerConfig.iconColor ? data.headerConfig.iconColor : qzIconColor">
      </span>
    </div>
    <!-- 有颜色就颜色，没有默认黑色 -->
    <div
      class="default-header-content-text"
      [style.color]="data.headerConfig && data.headerConfig.color ? data.headerConfig.color : qzIconColor">
      {{ data.headerConfig && data.headerConfig.title ? data.headerConfig.title : data.name}}
    </div>
  </div>
</ng-template>

<!-- 身体默认的模板 -->
<ng-template #bodyDefault let-data>
  <div>
    {{data.bodyConfig && data.bodyConfig.text ? data.bodyConfig.text : data.name}}
  </div>
</ng-template>

<!-- 底部默认的模板 -->
<ng-template #footDefault let-data>
</ng-template>

<!-- 添加流程节点模板内容 -->
<qz-dropdown-menu #addTemplate="qzDropDownMenuRef">
  <ul class="ul-add-list"  *ngFor="let item of addNodeConfig;index as i" (click)="add(NodeOperateType.ADD,item)">
    <li class="add-list">
      <span class="li-name">{{item.name}}</span>	
    </li>
  </ul>
</qz-dropdown-menu>

<!-- 条件节点末端添加流程节点模板内容 -->
<qz-dropdown-menu #addTemplates="qzDropDownMenuRef">
  <ul qz-menu *ngFor="let item of addNodeConfig;index as i" (click)="add('branchEndAdd',item)">
    <li qz-menu-item class="add-list">
      <span class="li-name">{{item.name}}</span>	
    </li>
  </ul>
</qz-dropdown-menu>